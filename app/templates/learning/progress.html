{% extends "base.html" %}

{% block title %}學習歷程{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between shrink-0">
  <div class="flex items-center gap-2">
    <i data-lucide="scroll-text" class="w-5 h-5 text-[var(--rpg-gold)]"></i>
    <h1 class="font-pixel text-sm text-[var(--rpg-gold)]">學習任務紀錄</h1>
  </div>
  {% set ns = namespace(total=0, count=0) %}
  {% for item in unit_data %}
    {% if item.status != 'locked' %}
      {% set ns.total = ns.total + item.rate %}
      {% set ns.count = ns.count + 1 %}
    {% endif %}
  {% endfor %}
  {% set total_progress = (ns.total / ns.count) | round(0) | int if ns.count > 0 else 0 %}
  <span class="font-tc text-xs font-bold text-[var(--rpg-text-secondary)]">
    總進度：{{ total_progress }}%
  </span>
</div>

<!-- Unit cards list -->
<div class="flex flex-col gap-3 flex-1 min-h-0 overflow-y-auto w-full">
  {% for item in unit_data %}
  {% set u = item.unit %}
  {% set record = item.record %}

  {% if item.status != 'locked' %}
  <!-- ActiveUnitCard -->
  <a href="/progress/{{ u.code }}" class="no-underline">
  <div class="flex flex-col gap-2.5 rounded w-full px-3 py-3
              bg-[var(--rpg-bg-panel)] sm:px-5 sm:py-4
              {% if item.status == 'completed' %}border-2 border-[var(--rpg-gold-dark)]
              {% else %}border-2 border-[var(--rpg-warning)]{% endif %}">

    <!-- Title row -->
    <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
      <span class="font-tc text-xs font-bold text-[var(--rpg-text-primary)]">
        {{ u.name }}
      </span>
      {% if item.status == 'completed' %}
      <div class="flex items-center gap-1.5 rounded-[3px] px-2.5 py-1 bg-[#4ade8033] self-start">
        <i data-lucide="check-circle-2" class="w-3 h-3 text-[var(--rpg-success)]"></i>
        <span class="font-tc text-[9px] font-bold text-[var(--rpg-success)]">已完成</span>
      </div>
      {% else %}
      <div class="flex items-center gap-1.5 rounded-[3px] px-2.5 py-1 bg-[#f59e0b33] self-start">
        <i data-lucide="clock" class="w-3 h-3 text-[var(--rpg-warning)]"></i>
        <span class="font-tc text-[9px] font-bold text-[var(--rpg-warning)]">進行中</span>
      </div>
      {% endif %}
    </div>

    <!-- Scores grid -->
    {% if record %}
    <div class="grid grid-cols-2 gap-3 w-full md:grid-cols-4 md:gap-4">
      <!-- 課程完成度 -->
      <div class="flex flex-col gap-0.5 w-full">
        <div class="flex items-center justify-between">
          <span class="font-tc text-[10px] text-[var(--rpg-text-secondary)]">課程完成度</span>
          <span class="font-tc text-[10px] font-bold text-[var(--rpg-text-primary)]">
            {{ record.completion_rate | round(0) | int if record.completion_rate else 0 }}%
          </span>
        </div>
        {% set cv = record.completion_rate | round(0) | int if record.completion_rate else 0 %}
        <div class="w-full h-2 rounded-sm bg-[var(--rpg-bg-input)] overflow-hidden">
          <div class="h-full rounded-sm {% if cv >= 70 %}bg-[var(--rpg-success)]{% elif cv >= 40 %}bg-[var(--rpg-warning)]{% else %}bg-[var(--rpg-danger)]{% endif %}" style="width: {{ cv }}%"></div>
        </div>
      </div>
      <!-- 隨堂測驗 -->
      <div class="flex flex-col gap-0.5 w-full">
        <div class="flex items-center justify-between">
          <span class="font-tc text-[10px] text-[var(--rpg-text-secondary)]">隨堂測驗</span>
          <span class="font-tc text-[10px] font-bold text-[var(--rpg-text-primary)]">
            {{ record.quiz_score | round(0) | int if record.quiz_score else 0 }}%
          </span>
        </div>
        {% set qv = record.quiz_score | round(0) | int if record.quiz_score else 0 %}
        <div class="w-full h-2 rounded-sm bg-[var(--rpg-bg-input)] overflow-hidden">
          <div class="h-full rounded-sm {% if qv >= 70 %}bg-[var(--rpg-success)]{% elif qv >= 40 %}bg-[var(--rpg-warning)]{% else %}bg-[var(--rpg-danger)]{% endif %}" style="width: {{ qv }}%"></div>
        </div>
      </div>
      <!-- 課後作業 -->
      <div class="flex flex-col gap-0.5 w-full">
        <div class="flex items-center justify-between">
          <span class="font-tc text-[10px] text-[var(--rpg-text-secondary)]">課後作業</span>
          <span class="font-tc text-[10px] font-bold text-[var(--rpg-text-primary)]">
            {{ record.homework_score | round(0) | int if record.homework_score else 0 }}%
          </span>
        </div>
        {% set hv = record.homework_score | round(0) | int if record.homework_score else 0 %}
        <div class="w-full h-2 rounded-sm bg-[var(--rpg-bg-input)] overflow-hidden">
          <div class="h-full rounded-sm {% if hv >= 70 %}bg-[var(--rpg-success)]{% elif hv >= 40 %}bg-[var(--rpg-warning)]{% else %}bg-[var(--rpg-danger)]{% endif %}" style="width: {{ hv }}%"></div>
        </div>
      </div>
      <!-- 額外練習 -->
      <div class="flex flex-col gap-0.5 w-full">
        <div class="flex items-center justify-between">
          <span class="font-tc text-[10px] text-[var(--rpg-text-secondary)]">額外練習</span>
          <span class="font-tc text-[10px] font-bold text-[var(--rpg-text-primary)]">
            +{{ record.bonus_points | default(0) }}
          </span>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Unlock text -->
    {% if item.status == 'completed' %}
    <div class="flex items-center gap-1.5 pt-1">
      <i data-lucide="lock-open" class="w-3 h-3 text-[var(--rpg-success)]"></i>
      <span class="font-tc text-[10px] text-[var(--rpg-success)]">
        已解鎖：{{ item.attr_label }}
      </span>
    </div>
    {% endif %}
  </div>
  </a>

  {% else %}
  <!-- LockedUnitCard -->
  <div class="flex flex-col gap-2 rounded w-full px-3 py-3
              bg-[var(--rpg-bg-panel)] border-2 border-[#333]
              sm:flex-row sm:items-center sm:justify-between sm:px-5 sm:py-3.5 sm:gap-0">
    <div class="flex items-center gap-2">
      <i data-lucide="lock" class="w-4 h-4 text-[var(--rpg-text-secondary)]"></i>
      <span class="font-tc text-xs font-bold text-[var(--rpg-text-secondary)]">
        {{ u.name }}
      </span>
    </div>
    <div class="flex items-center gap-1.5">
      <div class="flex items-center gap-1.5 rounded-[3px] px-2.5 py-1 border border-[#333]">
        <span class="font-tc text-[9px] font-bold text-[var(--rpg-text-secondary)]">未解鎖</span>
      </div>
      <span class="font-tc text-[10px] text-[var(--rpg-text-secondary)]">{{ item.attr_label }}</span>
    </div>
  </div>
  {% endif %}

  {% endfor %}

  {% if not unit_data %}
  <div class="flex flex-col items-center justify-center py-12 text-center">
    <i data-lucide="scroll-text" class="w-10 h-10 text-[var(--rpg-text-secondary)] mb-3"></i>
    <p class="font-tc text-sm text-[var(--rpg-text-secondary)]">尚無學習單元資料。</p>
  </div>
  {% endif %}
</div>
{% endblock %}
