{% extends "base.html" %}

{% block title %}{{ unit.name if unit else '單元詳情' }}{% endblock %}

{% block content %}
<!-- Back button -->
<a href="/progress" class="flex items-center gap-1.5 font-tc text-xs text-[var(--rpg-text-secondary)] hover:text-[var(--rpg-gold)] shrink-0">
  <i data-lucide="arrow-left" class="w-4 h-4"></i>返回學習歷程
</a>

{% if unit %}
<!-- Unit detail content -->
<div class="flex flex-col gap-4 flex-1 min-h-0 overflow-y-auto">
  <!-- Header with unit name + status -->
  <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
    <h1 class="font-pixel text-sm text-[var(--rpg-gold)]">{{ unit.name }}</h1>
    {% if record and record.completion_rate and record.completion_rate >= 80 %}
    <div class="flex items-center gap-1.5 rounded-[3px] px-2.5 py-1 bg-[#4ade8033] self-start">
      <i data-lucide="check-circle-2" class="w-3 h-3 text-[var(--rpg-success)]"></i>
      <span class="font-tc text-[9px] font-bold text-[var(--rpg-success)]">已完成</span>
    </div>
    {% elif record %}
    <div class="flex items-center gap-1.5 rounded-[3px] px-2.5 py-1 bg-[#f59e0b33] self-start">
      <i data-lucide="clock" class="w-3 h-3 text-[var(--rpg-warning)]"></i>
      <span class="font-tc text-[9px] font-bold text-[var(--rpg-warning)]">進行中</span>
    </div>
    {% else %}
    <div class="flex items-center gap-1.5 rounded-[3px] px-2.5 py-1 border border-[#333] self-start">
      <span class="font-tc text-[9px] font-bold text-[var(--rpg-text-secondary)]">未解鎖</span>
    </div>
    {% endif %}
  </div>

  <!-- Scores panel -->
  {% if record %}
  <div class="rounded px-4 py-4 bg-[var(--rpg-bg-panel)] border-2 border-[var(--rpg-gold-dark)]">
    <p class="font-tc text-xs font-bold text-[var(--rpg-text-secondary)] mb-3">學習成績</p>
    <div class="grid grid-cols-2 gap-3 md:grid-cols-4">
      <!-- 課程完成度 -->
      <div class="flex flex-col gap-0.5 w-full">
        <div class="flex items-center justify-between">
          <span class="font-tc text-[10px] text-[var(--rpg-text-secondary)]">課程完成度</span>
          <span class="font-tc text-[10px] font-bold text-[var(--rpg-text-primary)]">
            {{ record.completion_rate | round(0) | int if record.completion_rate else 0 }}%
          </span>
        </div>
        {% set cv = record.completion_rate | round(0) | int if record.completion_rate else 0 %}
        <div class="w-full h-2 rounded-sm bg-[var(--rpg-bg-input)] overflow-hidden">
          <div class="h-full rounded-sm {% if cv >= 70 %}bg-[var(--rpg-success)]{% elif cv >= 40 %}bg-[var(--rpg-warning)]{% else %}bg-[var(--rpg-danger)]{% endif %}" style="width: {{ cv }}%"></div>
        </div>
      </div>
      <!-- 隨堂測驗 -->
      <div class="flex flex-col gap-0.5 w-full">
        <div class="flex items-center justify-between">
          <span class="font-tc text-[10px] text-[var(--rpg-text-secondary)]">隨堂測驗</span>
          <span class="font-tc text-[10px] font-bold text-[var(--rpg-text-primary)]">
            {{ record.quiz_score | round(0) | int if record.quiz_score else 0 }}%
          </span>
        </div>
        {% set qv = record.quiz_score | round(0) | int if record.quiz_score else 0 %}
        <div class="w-full h-2 rounded-sm bg-[var(--rpg-bg-input)] overflow-hidden">
          <div class="h-full rounded-sm {% if qv >= 70 %}bg-[var(--rpg-success)]{% elif qv >= 40 %}bg-[var(--rpg-warning)]{% else %}bg-[var(--rpg-danger)]{% endif %}" style="width: {{ qv }}%"></div>
        </div>
      </div>
      <!-- 課後作業 -->
      <div class="flex flex-col gap-0.5 w-full">
        <div class="flex items-center justify-between">
          <span class="font-tc text-[10px] text-[var(--rpg-text-secondary)]">課後作業</span>
          <span class="font-tc text-[10px] font-bold text-[var(--rpg-text-primary)]">
            {{ record.homework_score | round(0) | int if record.homework_score else 0 }}%
          </span>
        </div>
        {% set hv = record.homework_score | round(0) | int if record.homework_score else 0 %}
        <div class="w-full h-2 rounded-sm bg-[var(--rpg-bg-input)] overflow-hidden">
          <div class="h-full rounded-sm {% if hv >= 70 %}bg-[var(--rpg-success)]{% elif hv >= 40 %}bg-[var(--rpg-warning)]{% else %}bg-[var(--rpg-danger)]{% endif %}" style="width: {{ hv }}%"></div>
        </div>
      </div>
      <!-- 額外練習 -->
      <div class="flex flex-col gap-0.5 w-full">
        <div class="flex items-center justify-between">
          <span class="font-tc text-[10px] text-[var(--rpg-text-secondary)]">額外練習</span>
          <span class="font-tc text-[10px] font-bold text-[var(--rpg-text-primary)]">
            +{{ record.bonus_points | default(0) }}
          </span>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Attribute selection -->
  {% if available %}
  <div class="rounded px-4 py-4 bg-[var(--rpg-bg-panel)] border-2 border-[var(--rpg-gold-dark)]">
    <p class="font-tc text-xs font-bold text-[var(--rpg-text-secondary)] mb-3">
      選擇角色屬性 — {{ attr_label }}
    </p>
    {% for attr_type, options in available.items() %}
    <div class="flex flex-col gap-2 mb-4">
      <span class="font-tc text-[10px] text-[var(--rpg-gold)]">{{ attr_type }}</span>
      <div class="flex flex-wrap gap-2" id="attr-group-{{ attr_type | replace(' ', '-') }}">
        {% for option in options %}
        <button class="attr-btn font-tc text-xs rounded px-3 py-1.5 border transition-colors
                       {% if chosen_attrs.get(attr_type) == option %}
                         bg-[var(--rpg-gold-dark)] border-[var(--rpg-gold)] text-[var(--rpg-gold-bright)] selected
                       {% else %}
                         bg-[var(--rpg-bg-panel)] border-[var(--rpg-gold-dark)] text-[var(--rpg-text-primary)]
                         hover:border-[var(--rpg-gold)] hover:text-[var(--rpg-gold)]
                       {% endif %}"
                data-unit="{{ unit.code }}"
                data-attr-type="{{ attr_type }}"
                data-attr-value="{{ option }}"
                onclick="selectAttr(this)">
          {% if chosen_attrs.get(attr_type) == option %}
          <i data-lucide="check" class="w-3 h-3 inline mr-1"></i>
          {% endif %}
          {{ option }}
        </button>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
    <div id="attr-result" class="font-tc text-xs mt-2"></div>
  </div>
  {% endif %}
</div>
{% else %}
<!-- Unit not found -->
<div class="flex flex-col items-center gap-3 py-16 text-center">
  <p class="font-tc text-sm text-[var(--rpg-text-secondary)]">找不到此單元</p>
  <a href="/progress" class="font-tc text-xs text-[var(--rpg-gold)] hover:underline">返回學習歷程</a>
</div>
{% endif %}
{% endblock %}

{% block scripts_extra %}
<script>
async function selectAttr(btn) {
  const unitCode  = btn.dataset.unit;
  const attrType  = btn.dataset.attrType;
  const attrValue = btn.dataset.attrValue;
  const resultEl  = document.getElementById('attr-result');

  btn.disabled = true;
  try {
    const resp = await fetch('/api/config/' + unitCode, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ attribute_type: attrType, attribute_value: attrValue }),
    });
    const data = await resp.json();
    if (!resp.ok) {
      resultEl.className = 'font-tc text-xs mt-2 text-[var(--rpg-danger)]';
      resultEl.textContent = data.detail || '儲存失敗';
      return;
    }

    // Update sibling button styles in the same group
    const group = btn.closest('[id^="attr-group-"]');
    if (group) {
      group.querySelectorAll('.attr-btn').forEach(function(b) {
        b.classList.remove(
          'bg-[var(--rpg-gold-dark)]', 'border-[var(--rpg-gold)]', 'text-[var(--rpg-gold-bright)]', 'selected'
        );
        b.classList.add(
          'bg-[var(--rpg-bg-panel)]', 'border-[var(--rpg-gold-dark)]', 'text-[var(--rpg-text-primary)]'
        );
        // Remove inline check icon
        const icon = b.querySelector('[data-lucide="check"]');
        if (icon) icon.remove();
      });
      btn.classList.add(
        'bg-[var(--rpg-gold-dark)]', 'border-[var(--rpg-gold)]', 'text-[var(--rpg-gold-bright)]', 'selected'
      );
      btn.classList.remove(
        'bg-[var(--rpg-bg-panel)]', 'border-[var(--rpg-gold-dark)]', 'text-[var(--rpg-text-primary)]'
      );
    }

    const tokenMsg = data.tokens_spent > 0 ? '（扣除 ' + data.tokens_spent + ' 代幣）' : '';
    resultEl.className = 'font-tc text-xs mt-2 text-[var(--rpg-success)]';
    resultEl.textContent = '✓ 已選擇：' + attrValue + ' ' + tokenMsg;
  } catch (e) {
    resultEl.className = 'font-tc text-xs mt-2 text-[var(--rpg-danger)]';
    resultEl.textContent = '網路錯誤，請稍後再試';
  } finally {
    btn.disabled = false;
  }
}
</script>
{% endblock %}
