{% extends "base.html" %}

{% block title %}儀表板{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between shrink-0">
  <div>
    <h1 class="font-pixel text-sm text-[var(--rpg-gold)]">冒險者儀表板</h1>
    <p class="font-tc text-xs mt-1 text-[var(--rpg-text-secondary)]">
      {% if user %}歡迎回來，{{ user.name }}！{% else %}歡迎來到 Scholaverse！{% endif %}
    </p>
  </div>
</div>

<!-- Top row: Character + Progress -->
<div class="flex flex-col gap-6 flex-1 min-h-0 overflow-y-auto lg:flex-row lg:overflow-y-hidden">
  <!-- Left: Character Preview -->
  <div class="flex flex-col items-center w-full shrink-0 rounded p-4 gap-3
              bg-[var(--rpg-bg-panel)] border-2 border-[var(--rpg-gold-dark)]
              lg:w-80 lg:h-full">
    <span class="font-tc text-xs font-bold tracking-widest text-center text-[var(--rpg-gold)]">我的角色</span>

    {% set border_style = latest_card.border_style if latest_card and latest_card.border_style else 'copper' %}
    {% if border_style == 'gold' %}
      {% set border_color = 'var(--rpg-border-gold)' %}
    {% elif border_style == 'silver' %}
      {% set border_color = 'var(--rpg-border-silver)' %}
    {% else %}
      {% set border_color = 'var(--rpg-border-copper)' %}
    {% endif %}

    <div class="w-40 h-56 md:w-[200px] md:h-[280px] rounded overflow-hidden"
         style="border: 3px solid {{ border_color }};{% if border_style == 'gold' %} box-shadow: 0 0 12px 2px rgba(255,215,0,0.4);{% endif %}">
      {% if latest_card and latest_card.image_url %}
      <img src="{{ latest_card.image_url }}" alt="角色卡牌" class="w-full h-full object-cover">
      {% else %}
      <div class="w-full h-full bg-[var(--rpg-bg-card)] flex flex-col items-center justify-center gap-2">
        <i data-lucide="image" class="w-10 h-10 text-[var(--rpg-text-secondary)] opacity-40"></i>
        <span class="font-tc text-[10px] text-[var(--rpg-text-secondary)]">尚未生成卡牌</span>
      </div>
      {% endif %}
    </div>

    <span class="font-tc text-xs font-bold text-center text-[var(--rpg-text-primary)]">
      Lv.{{ latest_card.level_number if latest_card else '--' }}
    </span>

    {% if latest_card and border_style == 'gold' %}
    <div class="flex items-center justify-center gap-1 w-full">
      <i data-lucide="crown" class="w-3.5 h-3.5 text-[var(--rpg-gold-bright)]"></i>
      <span class="font-tc text-[9px] font-bold text-[var(--rpg-gold-bright)]">金色邊框</span>
    </div>
    {% endif %}
  </div>

  <!-- Right: Progress Panel -->
  <div class="flex flex-col flex-1 min-w-0 rounded px-4 py-4 gap-4
              bg-[var(--rpg-bg-panel)] border-2 border-[var(--rpg-gold-dark)]
              overflow-y-auto md:px-6 md:py-5">
    <h2 class="font-tc text-sm font-black tracking-widest text-[var(--rpg-gold)] shrink-0">
      學習任務進度
    </h2>

    {% for unit in units %}
      {% set record = records_by_unit.get(unit.id) %}
      {% set rate = record.completion_rate | default(0) if record else 0 %}
      {% set rate = rate | round(0) | int %}
      {% if not record %}
        {% set status = 'locked' %}
      {% elif rate >= 70 %}
        {% set status = 'success' %}
      {% else %}
        {% set status = 'warning' %}
      {% endif %}

      <div class="flex flex-col w-full gap-1.5">
        <div class="flex items-center justify-between w-full">
          <span class="font-tc text-[10px] font-bold text-[var(--rpg-text-primary)]">
            {{ unit.name }}
          </span>
          {% if status != 'locked' %}
          <span class="font-tc text-[8px] font-black
                       {% if status == 'success' %}text-[var(--rpg-success)]{% else %}text-[var(--rpg-warning)]{% endif %}">
            {{ rate }}%
          </span>
          {% else %}
          <div class="flex items-center gap-1">
            <i data-lucide="lock" class="w-3 h-3 text-[var(--rpg-text-secondary)]"></i>
            <span class="font-tc text-[10px] font-bold text-[var(--rpg-text-secondary)]">未解鎖</span>
          </div>
          {% endif %}
        </div>

        <div class="w-full h-3 rounded-sm bg-[var(--rpg-bg-input)] overflow-hidden">
          {% if status != 'locked' and rate > 0 %}
          <div class="h-full rounded-sm {% if status == 'success' %}bg-[var(--rpg-success)]{% else %}bg-[var(--rpg-warning)]{% endif %}"
               style="width: {{ rate }}%"></div>
          {% endif %}
        </div>

        <span class="font-tc text-xs text-[var(--rpg-text-secondary)]">
          {% if status != 'locked' %}已解鎖：{% endif %}{{ unit.unlock_attribute }}
        </span>
      </div>
    {% endfor %}

    {% if not units %}
    <p class="font-tc text-sm text-[var(--rpg-text-secondary)]">尚無學習單元資料。</p>
    {% endif %}
  </div>
</div>

<!-- Quick actions -->
<div class="flex flex-col gap-3 w-full shrink-0 sm:flex-row sm:gap-4">
  <a href="/cards" class="flex items-center justify-center gap-2 rounded px-4 py-2.5 text-xs font-bold font-tc
                          bg-[var(--rpg-bg-panel)] border-2 border-[var(--rpg-gold-dark)] text-[var(--rpg-text-primary)]
                          transition-opacity hover:opacity-90 active:opacity-75 flex-1">
    <i data-lucide="image" class="w-4 h-4 text-[var(--rpg-gold)]"></i>查看卡牌
  </a>
  <a href="/hall" class="flex items-center justify-center gap-2 rounded px-4 py-2.5 text-xs font-bold font-tc
                         bg-[var(--rpg-bg-panel)] border-2 border-[var(--rpg-gold-dark)] text-[var(--rpg-text-primary)]
                         transition-opacity hover:opacity-90 active:opacity-75 flex-1">
    <i data-lucide="swords" class="w-4 h-4 text-[var(--rpg-gold)]"></i>角色大廳
  </a>
  <a href="/progress" class="flex items-center justify-center gap-2 rounded px-4 py-2.5 text-xs font-bold font-tc
                             bg-[var(--rpg-gold-dark)] border-2 border-[var(--rpg-gold)] text-[var(--rpg-gold-bright)]
                             transition-opacity hover:opacity-90 active:opacity-75 flex-1">
    <i data-lucide="sparkles" class="w-4 h-4 text-[var(--rpg-gold-bright)]"></i>前往學習歷程
  </a>
</div>
{% endblock %}
