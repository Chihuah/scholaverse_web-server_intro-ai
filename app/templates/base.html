<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Scholaverse - {% block title %}{% endblock %}</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind config (extends font families) -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            pixel: ['"Press Start 2P"', 'monospace'],
            tc: ['"Noto Sans TC"', 'sans-serif'],
          },
        },
      },
    }
  </script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@2.0.4" integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/static/css/style.css">

  {% block head_extra %}{% endblock %}
</head>
<body class="h-screen font-tc bg-[var(--rpg-bg-dark)]">
  <div id="app" class="relative flex h-full overflow-hidden">

    <!-- Mobile overlay backdrop -->
    <div id="sidebar-backdrop"
         class="fixed inset-0 z-40 bg-black/60 lg:hidden hidden"
         onclick="closeSidebar()">
    </div>

    <!-- Sidebar -->
    <aside id="sidebar"
           class="flex flex-col w-60 shrink-0 h-full gap-4 px-3 py-4
                  bg-[var(--rpg-bg-panel)] border-r-2 border-[var(--rpg-gold-dark)]
                  fixed inset-y-0 left-0 z-50 transition-transform duration-200
                  -translate-x-full lg:static lg:translate-x-0">

      <!-- Close button (mobile) -->
      <button class="self-end p-1 lg:hidden text-[var(--rpg-gold)]"
              onclick="closeSidebar()">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>

      <!-- Logo -->
      <div class="flex flex-col items-center gap-1 px-2 py-2">
        <i data-lucide="shield" class="w-8 h-8 text-[var(--rpg-gold)]"></i>
        <span class="font-pixel text-[11px] tracking-widest text-center text-[var(--rpg-gold)]">
          SCHOLAVERSE
        </span>
        <span class="font-tc text-[9px] font-bold tracking-widest text-center text-[var(--rpg-text-secondary)]">
          學習冒險之旅
        </span>
      </div>

      <div class="h-0.5 w-full bg-[var(--rpg-gold-dark)] shrink-0"></div>

      <!-- Navigation -->
      <nav class="flex flex-col gap-1 flex-1">
        {% set nav_items = [
          ('/', 'layout-dashboard', '儀表板'),
          ('/cards', 'image', '我的卡牌'),
          ('/hall', 'swords', '角色大廳'),
          ('/progress', 'scroll-text', '學習歷程'),
        ] %}
        {% for href, icon, label in nav_items %}
        <a href="{{ href }}"
           onclick="closeSidebar()"
           class="flex items-center gap-2.5 w-full rounded px-3 py-2.5 text-xs font-bold font-tc transition-colors text-left
                  {% if request.url.path == href %}
                    bg-[var(--rpg-bg-card)] border border-[var(--rpg-gold-dark)] text-[var(--rpg-gold)]
                  {% else %}
                    border border-transparent text-[var(--rpg-text-secondary)] hover:text-[var(--rpg-gold)] hover:bg-[var(--rpg-bg-card)]/50
                  {% endif %}">
          <i data-lucide="{{ icon }}" class="w-[18px] h-[18px]"></i>
          <span>{{ label }}</span>
        </a>
        {% endfor %}

        {% if user and user.role in ('teacher', 'admin') %}
        <a href="/admin"
           onclick="closeSidebar()"
           class="flex items-center gap-2.5 w-full rounded px-3 py-2.5 text-xs font-bold font-tc transition-colors text-left
                  {% if request.url.path == '/admin' %}
                    bg-[var(--rpg-bg-card)] border border-[var(--rpg-gold-dark)] text-[var(--rpg-gold)]
                  {% else %}
                    border border-transparent text-[var(--rpg-text-secondary)] hover:text-[var(--rpg-gold)] hover:bg-[var(--rpg-bg-card)]/50
                  {% endif %}">
          <i data-lucide="settings" class="w-[18px] h-[18px]"></i>
          <span>管理後台</span>
        </a>
        {% endif %}
      </nav>

      <div class="h-0.5 w-full bg-[var(--rpg-gold-dark)] shrink-0"></div>

      <!-- User Info -->
      <div class="flex flex-col gap-2 px-1 py-2">
        {% if user %}
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full shrink-0 bg-[var(--rpg-gold-dark)] flex items-center justify-center">
            <span class="font-pixel text-[10px] text-[var(--rpg-gold)]">
              {{ user.email[0] | upper }}
            </span>
          </div>
          <span class="font-tc text-[11px] text-[var(--rpg-text-secondary)] truncate">
            {{ user.email }}
          </span>
        </div>
        <div class="flex items-center gap-1.5">
          <i data-lucide="coins" class="w-4 h-4 text-[var(--rpg-gold-bright)]"></i>
          <span class="font-tc text-[10px] font-bold text-[var(--rpg-gold-bright)]">
            {{ user.tokens }} 代幣
          </span>
        </div>
        {% else %}
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full shrink-0 bg-[var(--rpg-gold-dark)]/40 flex items-center justify-center">
            <i data-lucide="eye" class="w-4 h-4 text-[var(--rpg-text-secondary)]"></i>
          </div>
          <span class="font-tc text-[11px] text-[var(--rpg-text-secondary)]">訪客</span>
        </div>
        {% endif %}
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex flex-col flex-1 min-w-0 overflow-y-auto gap-6
                 px-4 py-5 md:px-6 md:py-6 lg:px-8 lg:py-7">

      <!-- Hamburger (mobile) -->
      <button class="self-start p-1 lg:hidden text-[var(--rpg-gold)] shrink-0"
              onclick="openSidebar()">
        <i data-lucide="menu" class="w-6 h-6"></i>
      </button>

      {% if guest_mode is defined and guest_mode and not user %}
      <!-- Guest mode banner -->
      <div class="flex items-center gap-2 rounded px-4 py-2.5 shrink-0
                  bg-[var(--rpg-gold-dark)]/30 border border-[var(--rpg-gold-dark)]">
        <i data-lucide="eye" class="w-4 h-4 text-[var(--rpg-gold)] shrink-0"></i>
        <span class="font-tc text-xs text-[var(--rpg-gold)]">
          訪客模式 — 您正在瀏覽示範資料，寫入操作已停用
        </span>
      </div>
      {% endif %}

      {% block content %}{% endblock %}
    </main>
  </div>

  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Sidebar toggle
    function openSidebar() {
      document.getElementById('sidebar').classList.remove('-translate-x-full');
      document.getElementById('sidebar-backdrop').classList.remove('hidden');
    }
    function closeSidebar() {
      document.getElementById('sidebar').classList.add('-translate-x-full');
      document.getElementById('sidebar-backdrop').classList.add('hidden');
    }
  </script>
  {% block scripts_extra %}{% endblock %}
</body>
</html>
