{% extends "base.html" %}

{% block title %}屬性規則設定{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex flex-col gap-3 w-full shrink-0 sm:flex-row sm:items-center sm:justify-between">
  <div class="flex items-center gap-3">
    <i data-lucide="sliders-horizontal" class="w-6 h-6 text-[var(--rpg-gold)]"></i>
    <h1 class="font-tc text-xl font-black tracking-widest text-[var(--rpg-gold)]">屬性規則設定</h1>
  </div>
  <a href="/admin"
     class="flex items-center gap-1.5 font-tc text-xs text-[var(--rpg-text-secondary)]
            hover:text-[var(--rpg-gold)] transition-colors">
    <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
    返回後台
  </a>
</div>

<!-- Rules by unit -->
{% for unit_code, attr_types in grouped.items() %}
<div class="rounded bg-[var(--rpg-bg-panel)] border-2 border-[var(--rpg-gold-dark)] overflow-hidden w-full shrink-0">
  <!-- Unit header -->
  <div class="flex items-center gap-2 px-5 py-3 bg-[var(--rpg-bg-card)] border-b border-[var(--rpg-gold-dark)]">
    <i data-lucide="scroll-text" class="w-4 h-4 text-[var(--rpg-gold)]"></i>
    <span class="font-tc text-xs font-bold text-[var(--rpg-gold)]">{{ unit_code | upper }}</span>
    <span class="font-tc text-[10px] text-[var(--rpg-text-secondary)]">— {{ unit_names.get(unit_code, unit_code) }}</span>
  </div>

  <div class="p-4">
    {% for attr_type, rules in attr_types.items() %}
    <div class="mb-4 last:mb-0">
      <!-- Collapsible header -->
      <button type="button"
              class="flex items-center justify-between w-full rounded px-4 py-2.5
                     bg-[var(--rpg-bg-card)] border border-[var(--rpg-gold-dark)]
                     hover:border-[var(--rpg-gold)] transition-colors"
              onclick="toggleSection(this)">
        <span class="font-tc text-xs font-bold text-[var(--rpg-text-primary)]">
          {{ attr_type }}
          <span class="font-tc text-[10px] text-[var(--rpg-text-secondary)] ml-2">({{ rules | length }} tiers)</span>
        </span>
        <svg class="section-arrow w-4 h-4 text-[var(--rpg-gold)] transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="square" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>

      <!-- Collapsible content -->
      <div class="section-content hidden mt-1">
        <div class="rounded bg-[var(--rpg-bg-card)]/30 border border-[var(--rpg-gold-dark)]/50 overflow-auto scrollbar-hide">
          <div class="min-w-[400px]">
            <!-- Table header -->
            <div class="flex items-center px-4 py-2 border-b border-[var(--rpg-gold-dark)]/50">
              <span class="font-tc text-[10px] font-bold text-[var(--rpg-gold)] w-14">Tier</span>
              <span class="font-tc text-[10px] font-bold text-[var(--rpg-gold)] flex-1">Options</span>
              <span class="font-tc text-[10px] font-bold text-[var(--rpg-gold)] flex-1">Labels</span>
              <span class="font-tc text-[10px] font-bold text-[var(--rpg-gold)] w-14 text-center"></span>
            </div>
            <!-- Table rows -->
            {% for rule in rules %}
            <div id="rule-row-{{ rule.id }}"
                 class="flex items-center px-4 py-2 border-b border-[var(--rpg-bg-input)]
                        {% if loop.index is odd %}bg-[var(--rpg-bg-card)]/20{% endif %}">
              <span class="font-pixel text-[10px] w-14
                {% if rule.tier == 'S' %}text-[var(--rpg-gold-bright)]
                {% elif rule.tier == 'A' %}text-[var(--rpg-gold)]
                {% elif rule.tier == 'B' %}text-[var(--rpg-text-primary)]
                {% elif rule.tier == 'C' %}text-[var(--rpg-text-secondary)]
                {% else %}text-[var(--rpg-text-secondary)]{% endif %}
              ">{{ rule.tier }}</span>
              <span class="font-tc text-[10px] text-[var(--rpg-text-primary)] flex-1" id="rule-options-{{ rule.id }}">
                {{ rule.options | join(', ') }}
              </span>
              <span class="font-tc text-[10px] text-[var(--rpg-text-secondary)] flex-1" id="rule-labels-{{ rule.id }}">
                {{ rule.labels.values() | join(', ') }}
              </span>
              <button type="button"
                      class="w-14 text-center rounded px-2 py-1 bg-[var(--rpg-bg-card)] border border-[var(--rpg-gold-dark)]
                             font-tc text-[10px] font-bold text-[var(--rpg-gold)]
                             hover:border-[var(--rpg-gold)] transition-colors"
                      data-rule-id="{{ rule.id }}"
                      data-options='{{ rule.options | tojson | e }}'
                      data-labels='{{ rule.labels | tojson | e }}'
                      onclick="openEditFromBtn(this)">
                編輯
              </button>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endfor %}

{% if not grouped %}
<div class="rounded bg-[var(--rpg-bg-panel)] border-2 border-[var(--rpg-gold-dark)] px-5 py-8 text-center w-full">
  <p class="font-tc text-xs text-[var(--rpg-text-secondary)]">尚無屬性規則資料。請先執行 seed script。</p>
</div>
{% endif %}

<!-- Edit Modal -->
<div id="edit-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
  <div class="w-full max-w-lg mx-4 rounded bg-[var(--rpg-bg-panel)] border-2 border-[var(--rpg-gold-dark)]">
    <div class="flex items-center gap-2 px-5 py-3 bg-[var(--rpg-bg-card)] border-b border-[var(--rpg-gold-dark)]">
      <i data-lucide="edit-3" class="w-4 h-4 text-[var(--rpg-gold)]"></i>
      <span class="font-tc text-xs font-bold text-[var(--rpg-gold)]">編輯規則</span>
    </div>
    <div class="p-5">
      <input type="hidden" id="edit-rule-id">

      <div class="mb-4">
        <label class="font-tc text-[10px] font-bold text-[var(--rpg-text-secondary)] block mb-1">Options（每行一個 key）</label>
        <textarea id="edit-options" rows="6"
                  class="w-full rounded px-3 py-2.5 bg-[var(--rpg-bg-input)] border-2 border-[var(--rpg-gold-dark)]
                         font-tc text-xs text-[var(--rpg-text-primary)] focus:outline-none focus:border-[var(--rpg-gold)]
                         resize-y"></textarea>
      </div>

      <div class="mb-4">
        <label class="font-tc text-[10px] font-bold text-[var(--rpg-text-secondary)] block mb-1">Labels（每行格式：key:中文標籤）</label>
        <textarea id="edit-labels" rows="6"
                  class="w-full rounded px-3 py-2.5 bg-[var(--rpg-bg-input)] border-2 border-[var(--rpg-gold-dark)]
                         font-tc text-xs text-[var(--rpg-text-primary)] focus:outline-none focus:border-[var(--rpg-gold)]
                         resize-y"></textarea>
      </div>

      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeEditModal()"
                class="rounded px-4 py-2 bg-[var(--rpg-bg-card)] border border-[var(--rpg-gold-dark)]
                       font-tc text-[10px] font-bold text-[var(--rpg-text-secondary)]
                       hover:border-[var(--rpg-gold)] transition-colors">
          取消
        </button>
        <button type="button" onclick="saveRule()"
                class="rounded px-4 py-2 bg-[var(--rpg-gold-dark)] border-2 border-[var(--rpg-gold)]
                       font-tc text-[10px] font-bold text-[var(--rpg-gold-bright)]
                       transition-opacity hover:opacity-90">
          儲存
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
function showToast(msg, type) {
  const toast = document.createElement('div');
  toast.className = 'fixed bottom-4 right-4 z-50 rounded px-4 py-3 font-tc text-xs font-bold transition-opacity ' +
    (type === 'success' ? 'bg-[var(--rpg-success)]/20 border border-[var(--rpg-success)] text-[var(--rpg-success)]' :
     'bg-[var(--rpg-danger)]/20 border border-[var(--rpg-danger)] text-[var(--rpg-danger)]');
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 2500);
}

function toggleSection(btn) {
  const content = btn.nextElementSibling;
  const arrow = btn.querySelector('.section-arrow');
  content.classList.toggle('hidden');
  arrow.classList.toggle('rotate-180');
}

function openEditFromBtn(btn) {
  const ruleId = btn.dataset.ruleId;
  const options = JSON.parse(btn.dataset.options);
  const labels = JSON.parse(btn.dataset.labels);
  openEditForm(ruleId, options, labels);
}

function openEditForm(ruleId, options, labels) {
  document.getElementById('edit-rule-id').value = ruleId;
  document.getElementById('edit-options').value = options.join('\n');

  const labelLines = [];
  for (const [key, val] of Object.entries(labels)) {
    labelLines.push(key + ':' + val);
  }
  document.getElementById('edit-labels').value = labelLines.join('\n');

  const modal = document.getElementById('edit-modal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  lucide.createIcons();
}

function closeEditModal() {
  const modal = document.getElementById('edit-modal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

async function saveRule() {
  const ruleId = document.getElementById('edit-rule-id').value;
  const optionsText = document.getElementById('edit-options').value.trim();
  const labelsText = document.getElementById('edit-labels').value.trim();

  const options = optionsText.split('\n').map(s => s.trim()).filter(Boolean);
  const labels = {};
  for (const line of labelsText.split('\n')) {
    const trimmed = line.trim();
    if (!trimmed) continue;
    const idx = trimmed.indexOf(':');
    if (idx === -1) {
      showToast('Labels 格式錯誤：' + trimmed, 'error');
      return;
    }
    labels[trimmed.slice(0, idx).trim()] = trimmed.slice(idx + 1).trim();
  }

  try {
    const resp = await fetch('/api/admin/rules/' + ruleId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ options, labels }),
    });

    if (!resp.ok) {
      const err = await resp.json();
      showToast(err.detail || '儲存失敗', 'error');
      return;
    }

    const data = await resp.json();

    const optionsCell = document.getElementById('rule-options-' + ruleId);
    const labelsCell = document.getElementById('rule-labels-' + ruleId);
    if (optionsCell) optionsCell.textContent = data.options.join(', ');
    if (labelsCell) labelsCell.textContent = Object.values(data.labels).join(', ');

    showToast('規則已更新', 'success');
    closeEditModal();
  } catch (e) {
    showToast('網路錯誤', 'error');
  }
}

document.getElementById('edit-modal').addEventListener('click', function(e) {
  if (e.target === this) closeEditModal();
});
</script>
{% endblock %}
